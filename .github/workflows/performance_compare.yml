name: Algorithmic Performance Comparison

on:
  push:
    branches: [ "main" ]
  workflow_dispatch:

jobs:
  benchmark:
    name: Comparison Profiling
    runs-on: ubuntu-latest
    steps:
    - name: Checkout Repository
      uses: actions/checkout@v4

    - name: Get CPU Hardware Info
      run: |
        # Extract CPU model name from the runner's hardware info
        MODEL=$(lscpu | grep "Model name" | cut -d':' -f2 | xargs)
        echo "CPU_MODEL=$MODEL" >> $GITHUB_ENV

    - name: Compile Both Algorithms
      run: |
        # Using -O3, -march=native, and -flto (Link Time Optimization) for peak performance
        # -ffast-math: Speeds up floating point operations (if any)
        # -fomit-frame-pointer: Frees up a register for general use
        g++ -O3 -std=c++11 -march=native -flto -ffast-math -fomit-frame-pointer heap_perm.cpp -o heap_test -pthread
        g++ -O3 -std=c++11 -march=native -flto -ffast-math -fomit-frame-pointer permpure_full.cpp -o pure_test -pthread

    - name: Execute and Capture Results
      id: run_tests
      run: |
        # Execute Heap's Algorithm and extract execution time from output
        ./heap_test > heap_raw.txt
        cat heap_raw.txt 
        TIME_HEAP=$(grep "EXECUTION_TIME" heap_raw.txt | cut -d':' -f2 | xargs)
        echo "TIME_HEAP=$TIME_HEAP" >> $GITHUB_ENV
        
        # Execute Position-Pure Algorithm and extract execution time from output
        ./pure_test > pure_raw.txt
        cat pure_raw.txt
        TIME_PURE=$(grep "EXECUTION_TIME" pure_raw.txt | cut -d':' -f2 | xargs)
        echo "TIME_PURE=$TIME_PURE" >> $GITHUB_ENV

    - name: Generate Combined Summary Report
      run: |
        # Construct the GitHub Step Summary table
        echo "### ðŸš€ Algorithmic Comparison Report (N=12)" >> $GITHUB_STEP_SUMMARY
        echo "| Algorithm | Complexity | Execution Time | Status |" >> $GITHUB_STEP_SUMMARY
        echo "| :--- | :--- | :--- | :--- |" >> $GITHUB_STEP_SUMMARY
        echo "| Heap's Permutation | O(n!) | \`${{ env.TIME_HEAP }} s\` | Baseline |" >> $GITHUB_STEP_SUMMARY
        echo "| **Position-Pure** | **O(n!)** | **\`${{ env.TIME_PURE }} s\`** | **Optimized** |" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "#### ðŸ’» Hardware Environment" >> $GITHUB_STEP_SUMMARY
        echo "- **CPU Model:** ${{ env.CPU_MODEL }}" >> $GITHUB_STEP_SUMMARY
        echo "- **Optimization Flags:** \`-O3 -march=native -flto -ffast-math\`" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "> **Note:** Both algorithms have a mathematical complexity of O(n!). The performance difference is due to constant-factor optimizations and hardware efficiency." >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "âœ… *Report generated successfully.*" >> $GITHUB_STEP_SUMMARY
